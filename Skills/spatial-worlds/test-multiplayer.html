<!DOCTYPE html>
<html>
<head>
    <title>Multiplayer Test - Two Players</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a1a;
            color: #fff;
            font-family: monospace;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .player-window {
            flex: 1;
            border: 2px solid #333;
            padding: 10px;
        }
        .player-window h3 {
            margin-top: 0;
            color: #4a9eff;
        }
        #log {
            white-space: pre-wrap;
            padding: 10px;
            background: #000;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        canvas {
            border: 2px solid #333;
            image-rendering: pixelated;
            width: 100% !important;
            height: auto !important;
        }
        .controls {
            margin-top: 10px;
            padding: 10px;
            background: #2a2a2a;
        }
        button {
            background: #4a9eff;
            color: white;
            border: none;
            padding: 8px 16px;
            cursor: pointer;
            margin-right: 5px;
        }
        button:hover {
            background: #3a7edf;
        }
    </style>
</head>
<body>
    <h2>ðŸŽ® Multiplayer Test - Two Players</h2>
    <div id="log">Initializing...</div>

    <div class="controls">
        <button onclick="connectPlayer1()">Connect Player 1</button>
        <button onclick="connectPlayer2()">Connect Player 2</button>
        <button onclick="moveP1Right()">Move P1 Right</button>
        <button onclick="moveP2Left()">Move P2 Left</button>
    </div>

    <div class="container">
        <div class="player-window">
            <h3>Player 1 View</h3>
            <div id="game1"></div>
        </div>
        <div class="player-window">
            <h3>Player 2 View</h3>
            <div id="game2"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.2/dist/phaser.js"></script>
    <script>
        const log = document.getElementById('log');
        function logMsg(msg) {
            log.textContent += `\n${new Date().toLocaleTimeString()}: ${msg}`;
            log.scrollTop = log.scrollHeight;
            console.log(msg);
        }

        let game1, game2;
        let ws1, ws2;
        let player1Id, player2Id;

        class GameScene extends Phaser.Scene {
            constructor(key, playerNum) {
                super(key);
                this.playerNum = playerNum;
                this.ws = null;
                this.playerId = null;
                this.localSprite = null;
                this.remotePlayers = new Map();
                this.labels = new Map();
            }

            preload() {
                // Simple colored rectangles instead of sprites for testing
                this.load.image('player', 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA8AAAAfCAYAAAAKsWbUAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAVUlEQVR4nO3SsQ2AMAwAwVMkGjZgFNagYwTWoGMU1mCBCIlPJgWIApL7yo+fe8vFzACAtl2SOCPz/LyZiTnnPK1t/l3d3SXJzFaS9l0dAB7qBlJoDzwJqFbVAAAAAElFTkSuQmCC');
            }

            create() {
                logMsg(`[P${this.playerNum}] Scene created`);

                // Add background
                this.add.rectangle(400, 300, 800, 600, 0x2d5016);

                // Add grid for reference
                for (let x = 0; x < 800; x += 50) {
                    this.add.line(0, 0, x, 0, x, 600, 0x3a6020);
                }
                for (let y = 0; y < 600; y += 50) {
                    this.add.line(0, 0, 0, y, 800, y, 0x3a6020);
                }

                logMsg(`[P${this.playerNum}] Ready for connection`);
            }

            connect(wsUrl) {
                this.ws = new WebSocket(wsUrl);

                this.ws.onopen = () => {
                    logMsg(`[P${this.playerNum}] âœ… Connected to server`);
                    this.ws.send(JSON.stringify({
                        type: 'join',
                        playerName: `Player_${this.playerNum}`,
                    }));
                };

                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    if (data.type === 'init') {
                        this.playerId = data.playerId;
                        if (this.playerNum === 1) player1Id = this.playerId;
                        if (this.playerNum === 2) player2Id = this.playerId;

                        logMsg(`[P${this.playerNum}] Got ID: ${this.playerId.slice(0, 8)}`);

                        // Spawn local player
                        this.localSprite = this.add.rectangle(400, 300, 20, 40, 0xff0000);
                        this.localSprite.setStrokeStyle(2, 0xffffff);

                        const localLabel = this.add.text(400, 260, `Player_${this.playerNum} (YOU)`, {
                            fontSize: '12px',
                            color: '#ffffff',
                            backgroundColor: '#ff0000',
                            padding: { x: 4, y: 2 }
                        }).setOrigin(0.5);
                        this.labels.set(this.playerId, localLabel);

                        logMsg(`[P${this.playerNum}] Local player spawned`);

                        // Spawn existing players
                        data.players.forEach((player) => {
                            if (player.id !== this.playerId) {
                                this.spawnRemotePlayer(player);
                            }
                        });
                    } else if (data.type === 'player_joined') {
                        logMsg(`[P${this.playerNum}] ðŸŽ‰ Player joined: ${data.player.id.slice(0, 8)}`);
                        if (data.player.id !== this.playerId) {
                            this.spawnRemotePlayer(data.player);
                        }
                    } else if (data.type === 'player_left') {
                        this.removeRemotePlayer(data.playerId);
                    } else if (data.type === 'state') {
                        data.players.forEach((player) => {
                            if (player.id !== this.playerId) {
                                this.updateRemotePlayer(player);
                            }
                        });
                    }
                };

                this.ws.onerror = (error) => {
                    logMsg(`[P${this.playerNum}] âŒ WebSocket error`);
                };
            }

            spawnRemotePlayer(player) {
                if (this.remotePlayers.has(player.id)) return;

                logMsg(`[P${this.playerNum}] ðŸ‘¥ Spawning remote player ${player.id.slice(0, 8)} at (${player.x}, ${player.y})`);

                const sprite = this.add.rectangle(player.x, player.y, 20, 40, 0x00ff00);
                sprite.setStrokeStyle(2, 0xffffff);
                sprite.setDepth(100);

                const label = this.add.text(player.x, player.y - 40, player.name, {
                    fontSize: '12px',
                    color: '#ffffff',
                    backgroundColor: '#00ff00',
                    padding: { x: 4, y: 2 }
                }).setOrigin(0.5);
                label.setDepth(1000);

                this.remotePlayers.set(player.id, { sprite, label });
                this.labels.set(player.id, label);

                logMsg(`[P${this.playerNum}] âœ… Remote player visible: sprite at (${sprite.x}, ${sprite.y}), visible=${sprite.visible}, depth=${sprite.depth}`);
            }

            updateRemotePlayer(player) {
                let playerData = this.remotePlayers.get(player.id);

                if (!playerData) {
                    this.spawnRemotePlayer(player);
                    return;
                }

                playerData.sprite.setPosition(player.x, player.y);
                playerData.label.setPosition(player.x, player.y - 40);
            }

            removeRemotePlayer(playerId) {
                const playerData = this.remotePlayers.get(playerId);
                if (playerData) {
                    playerData.sprite.destroy();
                    playerData.label.destroy();
                    this.remotePlayers.delete(playerId);
                }
            }

            movePlayer(dx, dy) {
                if (!this.localSprite || !this.ws || this.ws.readyState !== WebSocket.OPEN) return;

                this.localSprite.x += dx;
                this.localSprite.y += dy;

                const label = this.labels.get(this.playerId);
                if (label) {
                    label.setPosition(this.localSprite.x, this.localSprite.y - 40);
                }

                this.ws.send(JSON.stringify({
                    type: 'move',
                    position: { x: this.localSprite.x, y: this.localSprite.y },
                    timestamp: Date.now(),
                }));

                logMsg(`[P${this.playerNum}] Moved to (${this.localSprite.x}, ${this.localSprite.y})`);
            }
        }

        function connectPlayer1() {
            if (game1) {
                logMsg('Player 1 already connected');
                return;
            }

            game1 = new Phaser.Game({
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                parent: 'game1',
                backgroundColor: '#2d5016',
                scene: new GameScene('game1', 1)
            });

            setTimeout(() => {
                const scene = game1.scene.scenes[0];
                scene.connect('ws://localhost:3001');
            }, 500);
        }

        function connectPlayer2() {
            if (game2) {
                logMsg('Player 2 already connected');
                return;
            }

            game2 = new Phaser.Game({
                type: Phaser.AUTO,
                width: 800,
                height: 600,
                parent: 'game2',
                backgroundColor: '#2d5016',
                scene: new GameScene('game2', 2)
            });

            setTimeout(() => {
                const scene = game2.scene.scenes[0];
                scene.connect('ws://localhost:3001');
            }, 500);
        }

        function moveP1Right() {
            if (!game1) return;
            const scene = game1.scene.scenes[0];
            scene.movePlayer(50, 0);
        }

        function moveP2Left() {
            if (!game2) return;
            const scene = game2.scene.scenes[0];
            scene.movePlayer(-50, 0);
        }

        logMsg('Test page ready. Click buttons to connect players.');
    </script>
</body>
</html>
